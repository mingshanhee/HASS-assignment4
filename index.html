<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style></style>
</head>

<body>
    <svg></svg>
    <script src="https://d3js.org/d3.v6.js"></script>

    <script>

        function getMax (someMap) {
            var maxValue = null;
            for (var [key, value] of someMap) {
                maxValue = (!maxValue || maxValue < value) ? value : maxValue;
            }
            return maxValue;
        }

        function getMin (someMap) {
            var minValue = null;
            for (var [key, value] of someMap) {
                minValue = (!minValue || minValue > value) ? value : minValue;
            }
            return minValue;
        }

        let width = 1000, height = 600;

        // The svg
        let svg = d3.select("svg")
            .attr("viewBox", "0 0 " + width + " " + height)

        // Map and projection
        const path = d3.geoPath();
        const projection = d3.geoMercator()
            .center([103.851959, 1.290270])

        // Data and color scale
        const data = new Map();

        // Load external data and boot
        Promise.all([d3.json("https://raw.githubusercontent.com/Chi-Loong/HASS02.526/master/assignments/sgmap.json"),
        d3.csv("https://raw.githubusercontent.com/Chi-Loong/HASS02.526/master/assignments/population2021.csv", function (d) {
            data.set(d.Subzone.toLowerCase(), +d.Population)
        })]).then(csvData => {

            projection.fitExtent([[20, 20], [980, 580]], csvData[0]);

            console.log(csvData[0]);
            console.log(csvData[1]);
            let topo = csvData[0]

            console.log( "data", data)
            console.log(data.get('henderson hill'))

            const min = getMin(data)
            const max = getMax(data)
            console.log(min); // üëâÔ∏è 3
            console.log(max); // üëâÔ∏è 8

            const colorScale = d3.scaleLinear()
                .domain([min, max])
                .range(d3.schemeBlues[3]);

            let mouseOver = function (d) {
                d3.selectAll(".Country")
                    .transition()
                    .duration(200)
                    .style("opacity", .5)
                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("opacity", 1)
                    .style("stroke", "black")
            }

            let mouseLeave = function (d) {
                // d3.selectAll(".Country")
                //     .transition()
                //     .duration(200)
                //     .style("opacity", .8)

                d3.select(this)
                    .transition()
                    .duration(200)
                    .style("stroke", "transparent")
            }

            // Draw the map
            svg.append("g")
                .attr("id", "districts")
                .selectAll("path")
                .data(topo.features)
                .enter()
                .append("path")
                // draw each country
                .attr("d", d3.geoPath()
                    .projection(projection)
                )
                // set the color of each country
                .attr("fill", function (d) {
                    const idx = d['properties']['Subzone Name'].toLowerCase()
                    d.total = data.get(idx) || 0;
                    return colorScale(d.total);
                })
                .style("stroke", "black")
                .attr("class", "Country")
        })

        function getColor(d) {
            var dataRow = countryById.get(d.properties.name);
            if (dataRow) {
                console.log(dataRow);
                return colorScale(dataRow.mortality);
            } else {
                console.log("no dataRow", d);
                return "#ccc";
            }
        }
        function loaded(error, usa, mortality) {

            console.log(usa);
            console.log(mortality);

            colorScale.domain(d3.extent(mortality, function (d) { return d.mortality; }));

            var states = topojson.feature(usa, usa.objects.units).features;

            svg.selectAll('path.states')
                .data(states)
                .enter()
                .append('path')
                .attr('class', 'states')
                .attr('d', path)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide)
                .attr('fill', function (d, i) {
                    console.log(d.properties.name);
                    return getColor(d);
                })
                .append("title");

            var linear = colorScale;

            svg.append("g")
                .attr("class", "legendLinear")
                .attr("transform", "translate(20,20)");

            var legendLinear = d3.legend.color()
                .shapeWidth(30)
                .orient('horizontal')
                .scale(linear);

            svg.select(".legendLinear")
                .call(legendLinear);

        }


    </script>

</body>

</html>